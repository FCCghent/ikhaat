name: Update data
on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    steps:
      - name: Checkout Repo
        uses: actions/checkout@master
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
      - name: Install Dependencies
        run: yarn install --frozen-lockfile
      - name: Fetch data
        run: |
          echo "## Fetch data ðŸ“¥" >> $GITHUB_STEP_SUMMARY

          if yarn run gipod; then
            echo "âœ… Fetched gipod data âš ï¸" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to fetch gipod data âš ï¸" >> $GITHUB_STEP_SUMMARY
          fi

          if yarn run overpass; then
            echo "âœ… Fetched overpass data ðŸ—ºï¸" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to fetch overpass data ðŸ—ºï¸" >> $GITHUB_STEP_SUMMARY
          fi

          if yarn run data.stad.gent; then
            echo "âœ… Fetched data.stad.gent data ðŸ™ï¸" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to fetch data.stad.gent data ðŸ™ï¸" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Update files
        run: |
          rsync -rt --delete --exclude=".git" --exclude=".github" --exclude="node_modules" . dist/
      - name: Update changes in GitHub repository
        uses: EndBug/add-and-commit@v9
        with:
          add: 'dist'
          author_name: Haroen Viaene [bot]
          author_email: hello@haroen.me
          default_author: github_actor
          message: 'Built from ${{ steps.vars.outputs.sha_short }}'
          new_branch: test-branch
          pull: '--rebase --autostash'
          push: true
