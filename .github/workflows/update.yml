name: Update data
on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@master
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
      - name: Install Dependencies
        run: yarn install --frozen-lockfile
      - name: Fetch data
        run: |
          echo "## Fetch data 📥" >> $GITHUB_STEP_SUMMARY

          if yarn run gipod; then
            echo "✅ Fetched gipod data ⚠️" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Failed to fetch gipod data ⚠️" >> $GITHUB_STEP_SUMMARY
          fi

          if yarn run overpass; then
            echo "✅ Fetched overpass data 🗺️" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Failed to fetch overpass data 🗺️" >> $GITHUB_STEP_SUMMARY
          fi

          if yarn run data.stad.gent; then
            echo "✅ Fetched data.stad.gent data 🏙️" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Failed to fetch data.stad.gent data 🏙️" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Update files
        run: |
          rsync -rt --delete --exclude=".git" --exclude=".github" --exclude="node_modules" . dist/
      - name: Update changes in GitHub repository
        uses: EndBug/add-and-commit@v9
          with:
            add: 'dist'
            author_name: Haroen Viaene [bot]
            author_email: hello@haroen.me
            default_author: github_actor

            # Arguments for the git fetch command. If set to false, the action won't fetch the repo.
            # For more info as to why fetching is usually recommended, please see the "Performance on large repos" FAQ. 
            # Default: --tags --force
            fetch: false

            # The message for the commit.
            # Default: 'Commit from GitHub Actions (name of the workflow)'
            message: 'Built from ${{ steps.vars.outputs.sha_short }}'

            # If this input is set, the action will push the commit to a new branch with this name.
            # Default: ''
            new_branch: test-branch

            # The way the action should handle pathspec errors from the add and remove commands. Three options are available:
            # - ignore -> errors will be logged but the step won't fail
            # - exitImmediately -> the action will stop right away, and the step will fail
            # - exitAtEnd -> the action will go on, every pathspec error will be logged at the end, the step will fail.
            # Default: ignore
            pathspec_error_handling: ignore

            # Arguments for the git pull command. By default, the action does not pull.
            # Default: ''
            pull: '--rebase --autostash ...'

            # Whether to push the commit and, if any, its tags to the repo. It can also be used to set the git push arguments (see the paragraph below for more info)
            # Default: true
            push: true
